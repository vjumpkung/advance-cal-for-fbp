var et=Object.defineProperty;var ot=(t,i,e)=>i in t?et(t,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[i]=e;var x=(t,i,e)=>ot(t,typeof i!="symbol"?i+"":i,e);import{j as g,M as U,B as Z,T as W,a as K,b as it,d as st,S as nt}from"./@mui/material-BQdAtyIz.js";import{c as rt,r as S}from"./vendor-DM_OWPAt.js";import{B as C,Q as at}from"./react-toastify-6PrFfkGr.js";import{F as lt}from"./file-saver-B2VyKP5u.js";import{H as ut}from"./react-helmet-D1WOPrvJ.js";import{a as F}from"./axios-DXsv3KKR.js";import{v as ct}from"./uuid-Ch9TGLTe.js";import{l as m}from"./litegraph.js-CpwqBUsj.js";import{z as u}from"./zod-DXqQCM1T.js";import"./@emotion/react-6hH5lGvJ.js";import"./@emotion/styled-BTak2TOH.js";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(n){if(n.ep)return;n.ep=!0;const l=e(n);fetch(n.href,l)}})();var J,$=rt;J=$.createRoot,$.hydrateRoot;async function dt(t){const i=t.serialize(),e={};for(const o of t.computeExecutionOrder(!1,0)){const n=i.nodes.find(f=>f.id===o.id);if(o.isVirtualNode){o.applyToGraph&&o.applyToGraph(i);continue}if(o.mode===2||o.mode===4)continue;const l={},r=o.widgets;if(r)for(const f in r){const s=r[f];(!s.options||s.options.serialize!==!1)&&(l[s.name]=s.serializeValue?await s.serializeValue(n,f):s.value)}for(let f in o.inputs){let s=o.getInputNode(f);if(s){let c=o.getInputLink(f);for(;s.mode===4||s.isVirtualNode;){let p=!1;if(s.isVirtualNode)c=s.getInputLink(c.origin_slot),c&&(s=s.getInputNode(c.target_slot),s&&(p=!0));else if(c&&s.mode===4){let w=[c.origin_slot];if(s.inputs){w=w.concat(Object.keys(s.inputs));for(let _ in w)if(_=w[_],s.inputs[_].type===o.inputs[f].type){c=s.getInputLink(_),c&&(s=s.getInputNode(_)),p=!0;break}}}if(!p)break}c&&(l[o.inputs[f].name]=[String(c.origin_id),parseInt(c.origin_slot)])}}e[String(o.id)]={inputs:l,class_type:o.comfyClass}}for(const o in e)for(const n in e[o].inputs)Array.isArray(e[o].inputs[n])&&e[o].inputs[n].length===2&&!e[e[o].inputs[n][0]]&&delete e[o].inputs[n];return{workflow:i,output:e}}const X=ct().toString().replace(/-/gi,"");class pt{constructor(){x(this,"currentExecutingNode",null);x(this,"lastErrorNode",null);x(this,"errorNode",null)}}const L=new pt;function ft(){const t=m.LGraphCanvas.prototype.drawNode,i=m.LGraphCanvas.prototype.drawNodeShape;m.LGraphCanvas.prototype.drawNodeShape=function(e,o,n,l,r,f,s){var a;const c=i.apply(this,arguments),p=(a=L.errorNode)==null?void 0:a[e.id.toString()];let w=null,_=1;if(e.id===+L.currentExecutingNode?w="#0f0":p!=null&&p.errors?(w="red",_=2):L.lastErrorNode&&+L.lastErrorNode.node_id===e.id&&(w="#f0f",_=2),w){const d=e._shape||e.shape||m.LiteGraph.ROUND_SHAPE;o.lineWidth=_,o.globalAlpha=.8,o.beginPath(),d==m.LiteGraph.BOX_SHAPE?o.rect(-6,-6-m.LiteGraph.NODE_TITLE_HEIGHT,12+n[0]+1,12+n[1]+m.LiteGraph.NODE_TITLE_HEIGHT):d==m.LiteGraph.ROUND_SHAPE||d==m.LiteGraph.CARD_SHAPE&&e.flags.collapsed?o.roundRect(-6,-6-m.LiteGraph.NODE_TITLE_HEIGHT,12+n[0]+1,12+n[1]+m.LiteGraph.NODE_TITLE_HEIGHT,this.round_radius*2):d==m.LiteGraph.CARD_SHAPE?o.roundRect(-6,-6-m.LiteGraph.NODE_TITLE_HEIGHT,12+n[0]+1,12+n[1]+m.LiteGraph.NODE_TITLE_HEIGHT,[this.round_radius*2,this.round_radius*2,2,2]):d==m.LiteGraph.CIRCLE_SHAPE&&o.arc(n[0]*.5,n[1]*.5,n[0]*.5+6,0,Math.PI*2),o.strokeStyle=w,o.stroke(),o.strokeStyle=l,o.globalAlpha=1}if(p){o.lineWidth=2,o.strokeStyle="red";for(const d of p.errors)if(d.extra_info&&d.extra_info.input_name){const h=e.findInputSlot(d.extra_info.input_name);if(h!==-1){let y=e.getConnectionPos(!0,h);o.beginPath(),o.arc(y[0]-e.pos[0],y[1]-e.pos[1],12,0,2*Math.PI,!1),o.stroke()}}}return c},m.LGraphCanvas.prototype.drawNode=function(e,o){var n=this.editor_alpha,l=e.bgcolor;e.mode===2&&(this.editor_alpha=.4),e.mode===4&&(e.bgcolor="#FF00FF",this.editor_alpha=.2);const r=t.apply(this,arguments);return this.editor_alpha=n,e.bgcolor=l,r}}let T=null;async function ht(){const t=await F.get("/api/object_info");if(t.status===200)return t.data}async function gt(t){L.errorNode=null;const i=await dt(t),e=await F.post("/api/workflow",{workflow:i.output,client_id:X});if(e.status===200)return await e.data;throw{response:await e.data}}function Q(t){if(!T)return T=new WebSocket(`/ws?clientId=${X}`),T.binaryType="arraybuffer",T.addEventListener("open",()=>{t?(console.log("WebSocket Reconnected"),dispatchEvent(new CustomEvent("reconnected"))):console.log("WebSocket Open")}),T.addEventListener("error",()=>{T&&T.close(),console.log("WebSocket Error")}),T.addEventListener("close",()=>{console.log("Reconnecting"),dispatchEvent(new CustomEvent("reconnecting")),setTimeout(()=>{T=null,T=Q(!0)},300)}),T.addEventListener("message",i=>{try{const e=JSON.parse(i.data);switch(e.type){case"status":dispatchEvent(new CustomEvent("status",{detail:e.data.status}));break;case"progress":dispatchEvent(new CustomEvent("progress",{detail:e.data}));break;case"executing":dispatchEvent(new CustomEvent("executing",{detail:e.data.node}));break;case"progress":case"executed":case"execution_start":case"execution_success":case"execution_error":case"execution_cached":case"logs":dispatchEvent(new CustomEvent(e.type,{detail:e.data}));break}}catch(e){console.warn("Unhandled message:",i.data,e)}}),T}const V=u.union([u.number().int(),u.string()]),P=u.union([u.object({0:u.number(),1:u.number()}).passthrough().transform(t=>[t[0],t[1]]),u.tuple([u.number(),u.number()])]),mt=u.object({collapsed:u.boolean().optional(),pinned:u.boolean().optional(),allow_interaction:u.boolean().optional(),horizontal:u.boolean().optional(),skip_repeated_outputs:u.boolean().optional()}).passthrough(),B=u.union([u.string(),u.array(u.string()),u.number()]),H=u.union([u.number().int(),u.string().transform(t=>parseInt(t)).refine(t=>!isNaN(t),{message:"Invalid number"})]),yt=u.object({name:u.string(),type:B,link:u.number().nullable().optional(),slot_index:H.optional()}).passthrough(),_t=u.object({name:u.string(),type:B,links:u.array(u.number()).nullable().optional(),slot_index:H.optional()}).passthrough(),wt=u.object({"Node name for S&R":u.string().optional()}).passthrough(),bt=u.union([u.array(u.any()),u.record(u.any())]),Et=u.object({id:V,type:u.string(),pos:P,size:P,flags:mt,order:u.number(),mode:u.number(),inputs:u.array(yt).optional(),outputs:u.array(_t).optional(),properties:wt,widgets_values:bt.optional(),color:u.string().optional(),bgcolor:u.string().optional()}).passthrough(),xt=u.tuple([u.number(),V,H,V,H,B]),vt=u.object({title:u.string(),bounding:u.tuple([u.number(),u.number(),u.number(),u.number()]),color:u.string().optional(),font_size:u.number().optional(),locked:u.boolean().optional()}).passthrough(),Nt=u.object({links_ontop:u.boolean().optional(),align_to_grid:u.boolean().optional()}).passthrough(),Lt=u.object({last_node_id:u.number(),last_link_id:u.number(),nodes:u.array(Et),links:u.array(xt),groups:u.array(vt).optional(),config:Nt.optional().nullable(),version:u.number()});function kt(t){try{const i=JSON.parse(t);return Lt.parse(i)}catch(i){throw i instanceof u.ZodError?console.error("Validation error:",i.errors):console.error("Parsing error:",i),Error(i)}}const St=(t,i,e,o)=>{var l;const n=(l=o.target.files)==null?void 0:l[0];if(n&&i){L.currentExecutingNode=null,L.errorNode=null,L.lastErrorNode=null;const r=new FileReader;return r.onload=f=>{var s;try{const c=(s=f.target)==null?void 0:s.result,p=kt(c);i.clear(),i.configure(p),t&&(t.value=""),e.ds.offset=[0,0],e.setZoom(1,[0,0]),e.setDirty(!0,!0),C.success("Loading Workflow Success")}catch{C.error("Error loading workflow file. Please ensure it is a valid workflow.")}},r.onerror=()=>{C.error("Error reading file")},r.readAsText(n),n.name}},It={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"800px",height:"auto",bgcolor:"background.paper",border:"2px solid #000",boxShadow:24,p:4};function Ot(){const[t,i]=S.useState(!1),e=()=>i(!0),o=()=>i(!1),[n,l]=S.useState({traceback:[],node_id:"",node_type:"",exception_type:"",exception_message:""});return window.addEventListener("execution_error",({detail:r})=>{l(r),e()}),g.jsx("div",{children:g.jsx(U,{open:t,onClose:o,"aria-labelledby":"modal-modal-title","aria-describedby":"modal-modal-description",children:g.jsxs(Z,{sx:It,children:[g.jsxs(W,{id:"modal-modal-title",variant:"h5",component:"h2",children:[g.jsx("i",{className:"pi pi-exclamation-triangle",style:{color:"#ff4545"}})," ","Error Workflow Execution"]}),g.jsxs(W,{id:"modal-modal-title",fontFamily:"monospace",children:[n.exception_type," ",g.jsx("br",{})," ",n.exception_message," "]}),g.jsx(W,{id:"modal-modal-description",sx:{mt:2},fontFamily:"monospace",variant:"caption",color:"#828282",children:n.traceback}),g.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:g.jsx(K,{onClick:o,children:"Close"})})]})})})}const Tt={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"400px",bgcolor:"background.paper",border:"2px solid #000",boxShadow:24,p:4};function Ct({handleOpen:t,handleClose:i,open:e,invaliddetail:o}){return g.jsx("div",{children:g.jsx(U,{open:e,onClose:i,"aria-labelledby":"modal-modal-title","aria-describedby":"modal-modal-description",children:g.jsxs(Z,{sx:Tt,children:[g.jsxs(W,{id:"modal-modal-title",variant:"h5",component:"h2",children:[g.jsx("i",{className:"pi pi-exclamation-circle",style:{color:"#ffc400"}})," ","Invalid Workflow"]}),g.jsx(W,{id:"modal-modal-description",sx:{mt:2},fontFamily:"monospace",variant:"caption",children:Object.keys(o.node_errors).map(n=>g.jsxs("p",{style:{fontSize:"110%"},children:[g.jsxs("span",{style:{fontWeight:"bold"},children:["#",n," ",o.node_errors[n].class_type," :"]}),g.jsx("br",{}),o.node_errors[n].errors.map(l=>g.jsxs("span",{children:[`${l.details} - ${l.message}`,g.jsx("br",{})]}))]}))}),g.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:g.jsx(K,{onClick:i,children:"Close"})})]})})})}function jt(t){t===void 0&&(t={});const i=S.useRef(t.sort||Gt),e=S.useRef(t.filter||null),[o,n]=S.useState(()=>t.data?e.current?t.data.filter(e.current).sort(i.current):[...t.data].sort(i.current):[]);return S.useEffect(()=>C.onChange(a=>{if(a.status==="added"||a.status==="updated"){const d=q(a);if(e.current&&!e.current(d))return;n(h=>{let y=[];const I=h.findIndex(j=>j.id===d.id);return I!==-1?(y=h.slice(),Object.assign(y[I],d,{createdAt:Date.now()})):h.length===0?y=[d]:y=[d,...h],y.sort(i.current)})}}),[]),{notifications:o,clear:()=>{n([])},markAllAsRead:function(a){a===void 0&&(a=!0),n(d=>d.map(h=>(h.read=a,h)))},markAsRead:function(a,d){d===void 0&&(d=!0);let h=y=>(y.id===a&&(y.read=d),y);Array.isArray(a)&&(h=y=>(a.includes(y.id)&&(y.read=d),y)),n(y=>y.map(h))},add:a=>{if(o.find(h=>h.id===a.id))return null;const d=q(a);return n(h=>[...h,d].sort(i.current)),d.id},update:(a,d)=>{const h=o.findIndex(y=>y.id===a);return h!==-1?(n(y=>{const I=[...y];return Object.assign(I[h],d,{createdAt:d.createdAt||Date.now()}),I.sort(i.current)}),d.id):null},remove:a=>{n(d=>d.filter(Array.isArray(a)?h=>!a.includes(h.id):h=>h.id!==a))},find:a=>Array.isArray(a)?o.filter(d=>a.includes(d.id)):o.find(d=>d.id===a),sort:a=>{i.current=a,n(d=>d.slice().sort(a))},get unreadCount(){return o.reduce((a,d)=>d.read?a:a+1,0)}}}function q(t){return t.id==null&&(t.id=Date.now().toString(36).substring(2,9)),t.createdAt||(t.createdAt=Date.now()),t.read==null&&(t.read=!1),t}function Gt(t,i){return i.createdAt-t.createdAt}function zt({graph:t,canvas:i}){jt();const e=S.useRef(null),[o,n]=S.useState(!1),[l,r]=S.useState(!0),[f,s]=S.useState(null),[c,p]=S.useState("untitled"),[w,_]=S.useState({error:{},node_errors:{}}),[a,d]=S.useState(!1),[h,y]=S.useState(!1),I=()=>{var E;(E=e.current)==null||E.click()},j=()=>{if(t){const E=JSON.stringify(t.serialize()),R=new Blob([E],{type:"text/plain;charset=utf-8"}),A=prompt("Enter Filename : ",`workflow-${Date.now()}`);if(A===null)return;lt.saveAs(R,`${A}.json`),s(t.serialize()),p(A)}},v=()=>y(!0),k=()=>y(!1),b=()=>{t&&confirm("Clear workflow?")&&(L.currentExecutingNode=null,L.errorNode=null,L.lastErrorNode=null,t.clear(),C.info("Workflow Cleared"),p("untitled"),i.ds.offset=[0,0],i.setZoom(1,[0,0]),i.setDirty(!0,!0))},N=async()=>{try{L.currentExecutingNode=null,L.errorNode=null,L.lastErrorNode=null;const E=await gt(t);t.start(),n(!0)}catch(E){L.errorNode=E.response.data.node_errors,_(E.response.data),y(!0),n(!1)}},O=async()=>{try{await F.post("/api/interrupt",null),await C.warning("Workflow Interrupt")}catch(E){console.error(E)}finally{n(!1)}};S.useEffect(()=>{a?C.error("Reconnecting"):C.success("Connected to Websocket")},[a]),window.addEventListener("execution_success",({detail:E})=>{n(!1)}),window.addEventListener("execution_error",({detail:E})=>{n(!1)}),window.addEventListener("reconnecting",()=>{a||d(!0)}),window.addEventListener("reconnected",()=>{a&&d(!1)});const z=it({palette:{mode:"dark"}});return g.jsxs(g.Fragment,{children:[g.jsx(ut,{children:g.jsxs("title",{children:[l?"":"*",c+" ","- AdvFBP"]})}),g.jsx(st,{theme:z,children:g.jsxs(nt,{enableColorScheme:!0,children:[g.jsx(Ot,{}),g.jsx(Ct,{handleOpen:v,handleClose:k,open:h,invaliddetail:w})]})}),g.jsxs("div",{className:"topbar",children:[g.jsxs("div",{className:"leftmenu",children:[g.jsxs("button",{className:"buttonmenu",onClick:j,children:[g.jsx("i",{className:"pi pi-save"})," Save"]}),g.jsxs("button",{className:"buttonmenu",onClick:I,children:[g.jsx("i",{className:"pi pi-upload"})," Load"]}),g.jsx("input",{type:"file",ref:e,onChange:E=>{const R=St(e.current,t,i,E);R&&p(R.split(".")[0])},accept:".json",style:{display:"none"}}),g.jsxs("button",{className:"buttonmenu",onClick:b,children:[g.jsx("i",{className:"pi pi-eraser"})," Clear"]})]}),g.jsx("div",{className:"rightmenu",children:g.jsx("button",{className:"buttonmenuright",onClick:async()=>{o?await O():await N()},children:o?g.jsxs("span",{children:[g.jsx("i",{className:"pi pi-stop"})," Interrupt Workflow"]}):g.jsxs("span",{children:[g.jsx("i",{className:"pi pi-play"})," Run Workflow"]})})})]})]})}const D=Symbol(),M=Symbol();function Rt(t,i,e,o,n){function r(s){var a,d;if(t.widgets[0].last_y==null)return;let c=t.widgets[0].last_y,p=s[1]-c,w=0;const _=[];for(let h=0;h<t.widgets.length;h++){const y=t.widgets[h];y.type==="customtext"?_.push(y):y.computeSize?w+=y.computeSize(null)[1]+4:w+=m.LiteGraph.NODE_WIDGET_HEIGHT+4}p-=w,p/=_.length+(((a=t.imgs)==null?void 0:a.length)||0),p<50&&(p=50,t.size[1]=c+w+p*(_.length+(((d=t.imgs)==null?void 0:d.length)||0)),t.graph.setDirtyCanvas(!0));for(const h of t.widgets)h.y=c,h.type==="customtext"?(c+=p,h.computedHeight=p-_.length*4):h.computeSize?c+=h.computeSize()[1]+4:c+=m.LiteGraph.NODE_WIDGET_HEIGHT+4;t.inputHeight=p}const f={type:"customtext",name:i,get value(){return this.inputEl.value},set value(s){this.inputEl.value=s},draw:function(s,c,p,w,_){this.parent.inputHeight||r(t.size);const a=n.ds.scale>.5&&this.type==="customtext",d=10,h=s.canvas.getBoundingClientRect(),y=new DOMMatrix().scaleSelf(h.width/s.canvas.width,h.height/s.canvas.height).multiplySelf(s.getTransform()).translateSelf(d,d+w),I=new DOMMatrix().scaleSelf(y.a,y.d);Object.assign(this.inputEl.style,{transformOrigin:"0 0",transform:I,left:`${y.a+y.e}px`,top:`${y.d+y.f}px`,width:`${p-d*2}px`,height:`${this.parent.inputHeight-d*2}px`,position:"absolute",background:t.color?t.color:"",color:t.color?"white":"",zIndex:o._nodes.indexOf(t)}),this.inputEl.hidden=!a}};if(f.inputEl=document.createElement("textarea"),f.inputEl.className="comfy-multiline-input",f.inputEl.value=e.defaultVal,f.inputEl.placeholder=e.placeholder||"",document.addEventListener("mousedown",function(s){f.inputEl.contains(s.target)||f.inputEl.blur()}),f.parent=t,document.body.appendChild(f.inputEl),t.addCustomWidget(f),n.onDrawBackground=function(){for(let s in o._nodes){const c=o._nodes[s];for(let p in c.widgets){let w=c.widgets[p];Object.hasOwn(w,"inputEl")&&(w.inputEl.style.left="-8000px",w.inputEl.style.position="absolute")}}},t.onRemoved=function(){for(let s in this.widgets)this.widgets[s].inputEl&&this.widgets[s].inputEl.remove()},f.onRemove=()=>{var s;(s=f.inputEl)==null||s.remove(),--t[D]||(t.onResize=t[M],delete t[D],delete t[M])},t[D])t[D]++;else{t[D]=1;const s=t[M]=t.onResize;t.onResize=function(c){r(c),s&&s.apply(this,arguments)}}return{minWidth:400,minHeight:200,widget:f}}function Y(t,i){let e=t[1].default,{min:o,max:n,step:l}=t[1];return e==null&&(e=0),o==null&&(o=Number.MIN_SAFE_INTEGER),n==null&&(n=Number.MAX_SAFE_INTEGER),l==null&&(l=i),t[1].min=o,t[1].max=n,t[1].step=1*l,{val:e,config:{...t[1]}}}function tt(t){return t==="slider"?"slider":"number"}function At(t,i,e){let o=tt(e[1].display);const{val:n,config:l}=Y(e,1);return Object.assign(l,{precision:0}),{widget:t.addWidget(o,i,n,function(r){const f=this.options.step/10;let s=this.options.min%f;isNaN(s)&&(s=0),this.value=Math.round((r-s)/f)*f+s},l)}}const G={FLOAT(t,i,e){let o=tt(e[1].display),{val:n,config:l}=Y(e,.5);return{widget:t.addWidget(o,i,n,()=>{},l)}},INT(t,i,e){return At(t,i,e)},BOOLEAN(t,i,e){let o=e[1].default;return{widget:t.addWidget("toggle",i,o,()=>{},{on:e[1].label_on,off:e[1].label_off})}},STRING(t,i,e,o,n){const l=e[1].defaultVal?e[1].defaultVal:"",r=!!e[1].multiline;let f;return r?f=Rt(t,i,e[1],o,n):f={widget:t.addWidget("text",i,l,()=>{},{})},e[1].dynamicPrompts!=null&&(f.widget.dynamicPrompts=e[1].dynamicPrompts),f},COMBO(t,i,e){const o=e[0];let n=o[0];return e[1]&&e[1].default&&(n=e[1].default),{widget:t.addWidget("combo",i,n,()=>{},{values:o})}},SELECTFILE(t,i,e,o,n){let l;const r=document.createElement("input");return Object.assign(r,{type:"file",style:"display: none",onchange:async()=>{if(r.files.length){const f=r.files[0],s=new FormData;s.append("file",f);const c=await F.post("/api/upload/file",s);if(c.status!==200){console.error(c.data);return}t.widgets[0].value=c.data.path,r.value=""}}}),document.body.append(r),l=t.addWidget("button","Select File","file",()=>{r.click()}),t.onRemoved=function(){r.remove()},l.serialize=!1,{widget:l}}};async function Dt(t,i){class e{constructor(){x(this,"properties");x(this,"serialize_widgets");x(this,"isVirtualNode");x(this,"color",m.LGraphCanvas.node_colors.yellow.color);x(this,"bgcolor",m.LGraphCanvas.node_colors.yellow.bgcolor);x(this,"groupcolor",m.LGraphCanvas.node_colors.yellow.groupcolor);this.properties||(this.properties={},this.properties.text=""),G.STRING(this,"",["",{defaultVal:this.properties.text,multiline:!0}],t,i),this.serialize_widgets=!0,this.isVirtualNode=!0}}x(e,"category"),m.LiteGraph.registerNodeType("Note",Object.assign(e,{title_mode:m.LiteGraph.NORMAL_TITLE,title:"Note",collapsable:!0})),e.category="utils"}async function Wt(t,i){const o=class o{constructor(){x(this,"size");x(this,"__outputType");x(this,"inputs");x(this,"outputs");x(this,"isVirtualNode");x(this,"horizontal");x(this,"properties");this.properties||(this.properties={}),this.properties.showOutputText=o.defaultVisibility,this.properties.horizontal=!1;const l=this;l.addInput("","*"),l.addOutput(this.properties.showOutputText?"*":"","*"),l.onConnectionsChange=function(r,f,s,c){var j;if(this.applyOrientation(),s&&r===m.LiteGraph.OUTPUT&&new Set(this.outputs[0].links.map(k=>t.links[k].type).filter(k=>k!=="*")).size>1){const k=[];for(let b=0;b<this.outputs[0].links.length-1;b++){const N=this.outputs[0].links[b],O=t.links[N];k.push(O)}for(const b of k)t.getNodeById(b.target_id).disconnectInput(b.target_slot)}let p=this,w=[],_=null,a=null;for(;p;){w.unshift(p);const v=p.inputs[0].link;if(v!==null){const k=t.links[v],b=t.getNodeById(k.origin_id);if(b.constructor.type==="Reroute")b===this?(p.disconnectInput(k.target_slot),p=null):p=b;else{a=p,_=((j=b.outputs[k.origin_slot])==null?void 0:j.type)??null;break}}else{p=null;break}}const d=[this];let h=null;for(;d.length;){p=d.pop();const v=(p.outputs?p.outputs[0].links:[])||[];if(v.length)for(const k of v){const b=t.links[k];if(!b)continue;const N=t.getNodeById(b.target_id);if(N.constructor.type==="Reroute")d.push(N),w.push(N);else{const z=N.inputs&&N.inputs[b==null?void 0:b.target_slot]&&N.inputs[b.target_slot].type?N.inputs[b.target_slot].type:null;_&&z!==_?N.disconnectInput(b.target_slot):h=z}}}const y=_||h||"*",I=m.LGraphCanvas.link_type_colors[y];for(const v of w){v.outputs[0].type=_||"*",v.__outputType=y,v.outputs[0].name=v.properties.showOutputText?y:"",v.size=v.computeSize(),v.applyOrientation();for(const k of v.outputs[0].links||[]){const b=t.links[k];b&&(b.color=I)}}if(a){const v=t.links[a.inputs[0].link];v&&(v.color=I)}},this.clone=function(){const r=o.prototype.clone.apply(this);return r.removeOutput(0),r.addOutput(this.properties.showOutputText?"*":"","*"),r.size=r.computeSize(),r},this.isVirtualNode=!0}getExtraMenuOptions(l,r){r.unshift({content:(this.properties.showOutputText?"Hide":"Show")+" Type",callback:()=>{this.properties.showOutputText=!this.properties.showOutputText,this.properties.showOutputText?this.outputs[0].name=this.__outputType||this.outputs[0].type:this.outputs[0].name="",this.size=this.computeSize(),this.applyOrientation(),t.setDirtyCanvas(!0,!0)}},{content:(o.defaultVisibility?"Hide":"Show")+" Type By Default",callback:()=>{o.setDefaultTextVisibility(!o.defaultVisibility)}},{content:"Set "+(this.properties.horizontal?"Horizontal":"Vertical"),callback:()=>{this.properties.horizontal=!this.properties.horizontal,this.applyOrientation()}})}applyOrientation(){this.horizontal=this.properties.horizontal,this.horizontal?this.inputs[0].pos=[this.size[0]/2,0]:delete this.inputs[0].pos,t.setDirtyCanvas(!0,!0)}computeSize(){return[this.properties.showOutputText&&this.outputs&&this.outputs.length?Math.max(75,m.LiteGraph.NODE_TEXT_SIZE*this.outputs[0].name.length*.6+40):75,26]}clone(){}static setDefaultTextVisibility(l){o.defaultVisibility=l,l?localStorage["Comfy.RerouteNode.DefaultVisibility"]="true":delete localStorage["Comfy.RerouteNode.DefaultVisibility"]}};x(o,"category"),x(o,"defaultVisibility");let e=o;e.setDefaultTextVisibility(!!localStorage["Comfy.RerouteNode.DefaultVisibility"]),m.LiteGraph.registerNodeType("Reroute",Object.assign(e,{title_mode:m.LiteGraph.NO_TITLE,title:"Reroute",collapsable:!1})),e.category="utils"}const Ht={dark:{id:"dark",name:"Dark (Default)",colors:{node_slot:{INT:"#FFD500",FLOAT:"#A8DADC",STRING:"#ad7452",COMBO:"#FFA931",NDARRAY:"#6EE7B7"}}}};async function Ft(t,i,e){const o=s=>Object.keys(s).sort().reduce((c,p)=>(c[p]=s[p],c),{});function n(){var s=[];const c=t;for(const w in c){const _=c[w];var p=_.input.required;_.input.optional!==void 0&&(p=Object.assign({},_.input.required,_.input.optional));for(const a in p){const h=p[a][0];Array.isArray(h)||s.push(h)}for(const a in _.output){const d=_.output[a];s.push(d)}}return s}function l(s){var c=n();for(const p of c)s.colors.node_slot[p]||(s.colors.node_slot[p]="");return s.colors.node_slot=o(s.colors.node_slot),s}const r=async s=>{if(s=await l(s),s.colors){if(s.colors.node_slot&&(Object.assign(e.default_connection_color_byType,s.colors.node_slot),Object.assign(m.LGraphCanvas.link_type_colors,s.colors.node_slot)),s.colors.litegraph_base){e.node_title_color=s.colors.litegraph_base.NODE_TITLE_COLOR,e.default_link_color=s.colors.litegraph_base.LINK_COLOR;for(const c in s.colors.litegraph_base)s.colors.litegraph_base.hasOwnProperty(c)&&m.LiteGraph.hasOwnProperty(c)&&(m.LiteGraph[c]=s.colors.litegraph_base[c])}e.draw(!0,!0)}};let f=Ht.dark;await r(f)}function Mt(){m.LiteGraph.search_filter_enabled=!1,m.LiteGraph.middle_click_slot_add_default_node=!0}async function Vt(t,i,e){var c;var o=i.name;const n=(c=i.input)==null?void 0:c.required;for(const p in n){var l=n[p];if(typeof l[0]!="string")continue;var r=l[0];if(r in G){var f=l[1];if(!(f!=null&&f.forceInput))continue}if(r in e.slot_types_default_out||(e.slot_types_default_out[r]=["Reroute"]),e.slot_types_default_out[r].includes(o))continue;e.slot_types_default_out[r].push(o);const w=r.toLocaleLowerCase();w in m.LiteGraph.registered_slot_in_types||(m.LiteGraph.registered_slot_in_types[w]={nodes:[]}),m.LiteGraph.registered_slot_in_types[w].nodes.push(t.comfyClass)}var s=i.output;for(const p in s){var r=s[p];r in e.slot_types_default_in||(e.slot_types_default_in[r]=["Reroute"]),e.slot_types_default_in[r].push(o),r in m.LiteGraph.registered_slot_out_types||(m.LiteGraph.registered_slot_out_types[r]={nodes:[]}),m.LiteGraph.registered_slot_out_types[r].nodes.push(t.comfyClass),m.LiteGraph.slot_types_out.includes(r)||m.LiteGraph.slot_types_out.push(r)}m.LiteGraph.slot_types_default_out={},m.LiteGraph.slot_types_default_in={};for(const p in e.slot_types_default_out)m.LiteGraph.slot_types_default_out[p]=e.slot_types_default_out[p].slice(0,5);for(const p in e.slot_types_default_in)m.LiteGraph.slot_types_default_in[p]=e.slot_types_default_in[p].slice(0,5)}async function Bt(t,i,e){await Dt(i,e),await Wt(i),await Ft(t,i,e)}async function $t(t,i,e){await Mt()}function Pt(t){if(t==null)return"(unknown error)";const i=t.traceback.join("");return t.node_id,`Error occurred when executing ${t.node_type}:

${t.exception_message}

${i}`}function qt(t,i){window.addEventListener("status",({detail:e})=>{console.log("status",e)}),window.addEventListener("reconnecting",()=>{console.log("Reconnecting...")}),window.addEventListener("progress",({detail:e})=>{i.setDirtyCanvas(!0,!1)}),window.addEventListener("executing",({detail:e})=>{L.currentExecutingNode=e,i.setDirtyCanvas(!0,!1)}),window.addEventListener("executed",({detail:e})=>{L.currentExecutingNode=null;const o=i.getNodeById(e.node);o&&o.onExecuted&&o.onExecuted(e.output)}),window.addEventListener("execution_start",({detail:e})=>{L.lastErrorNode=null,C.info("Workflow Start")}),window.addEventListener("execution_success",({detail:e})=>{C.info("Workflow Execution Success"),i.stop()}),window.addEventListener("execution_error",({detail:e})=>{const o=Pt(e);L.lastErrorNode=e,L.currentExecutingNode=null,i.stop(),console.error(o)})}async function Ut(t){var i,e,o,n;((n=(o=(e=(i=t==null?void 0:t.input)==null?void 0:i.required)==null?void 0:e.path)==null?void 0:o[1])==null?void 0:n.select_file_path)===!0&&(t.input.required.selectfile=["SELECTFILE"])}async function Zt(t,i,e,o){if(i.name==="ShowText"){let n=function(l){var r,f;if(this.widgets){const s=this.widgets.findIndex(c=>c.name==="text");if(s!==-1){for(let c=s;c<this.widgets.length;c++)(f=(r=this.widgets[c]).onRemove)==null||f.call(r);this.widgets.length=s}}for(const s of l){const c=G.STRING(this,"text",["STRING",{multiline:!0}],e,o).widget;c.inputEl.readOnly=!0,c.inputEl.style.opacity=1,c.value=s}requestAnimationFrame(()=>{var c;const s=this.computeSize();s[0]<this.size[0]&&(s[0]=this.size[0]),s[1]<this.size[1]&&(s[1]=this.size[1]),(c=this.onResize)==null||c.call(this,s),e.setDirtyCanvas(!0,!1)})};t.onExecuted,t.prototype.onExecuted=function(l){n.call(this,l.text)}}}async function Kt(t,i,e){var n;const o={slot_types_default_out:{},slot_types_default_in:{}};for(const l in t){const r=t[l];await Ut(r);const f=(n=class extends m.LGraphNode{constructor(p){var h,y,I,j,v,k;super(p);x(this,"comfyClass",r.name);x(this,"graph",i);x(this,"canvas",e);const w=r.input.required;var _=r.input.required;r.input.optional!=null&&(_=Object.assign({},r.input.required,r.input.optional));const a={minWidth:1,minHeight:1};for(const b in _){const N=_[b],O=N[0],z=N[1]??{},E=[O,z],R=w&&b in w;let A=!0;(h=E[1])!=null&&h.forceInput?this.addInput(b,O):Array.isArray(O)?Object.assign(a,G.COMBO(this,b,E)||{}):`${O}:${b}`in G?Object.assign(a,G[`${O}:${b}`](this,b,E,this.graph,this.canvas)||{}):O in G?Object.assign(a,G[O](this,b,E,this.graph,this.canvas)||{}):(this.addInput(b,O),A=!1),A&&(a!=null&&a.widget)&&((y=a.widget).options??(y.options={}),R||(a.widget.options.inputIsOptional=!0),(I=E[1])!=null&&I.forceInput&&(a.widget.options.forceInput=!0),(j=E[1])!=null&&j.defaultInput&&(a.widget.options.defaultInput=!0),(v=E[1])!=null&&v.advanced&&(a.widget.advanced=!0),(k=E[1])!=null&&k.hidden&&(a.widget.hidden=!0))}for(const b in r.output){let N=r.output[b];N instanceof Array&&(N="COMBO");const O=r.output_name[b]||N,E={shape:r.output_is_list[b]?m.LiteGraph.GRID_SHAPE:m.LiteGraph.CIRCLE_SHAPE};this.addOutput(O,N,E)}const d=this.computeSize();d[0]=Math.max(a.minWidth,d[0]*1.5),d[1]=Math.max(a.minHeight,d[1]),this.size=d,this.serialize_widgets=!0}configure(p){const w=(_,a)=>{const d={...a};if(_.widget===void 0&&a.widget!==void 0)return this.inputs.push(_),a;for(const h of["name","type","shape"])_[h]!==void 0&&(d[h]=_[h]);return d};for(const _ of["inputs","outputs"]){const a=p[_]??[];p[_]=a.map((d,h)=>w(this[_][h]??{},d))}super.configure(p)}},x(n,"title",r.display_name||r.name),x(n,"nodeData",r),x(n,"category"),n);await Zt(f,r,i,e),await Vt(f,r,o),m.LiteGraph.registerNodeType(l,f),f.category=r.category}}async function Jt(t,i,e){const o=new m.LGraph,n=new m.LGraphCanvas(t,o);function l(){const f=Math.max(window.devicePixelRatio,1),{width:s,height:c}=t.getBoundingClientRect();t.width=Math.round(s*f),t.height=Math.round(c*f),t.getContext("2d").scale(f,f),n.draw(!0,!0)}l(),window.addEventListener("resize",l),m.LiteGraph.release_link_on_empty_shows_menu=!0,m.LiteGraph.alt_drag_do_clone_nodes=!0,m.LiteGraph.clearRegisteredTypes();const r=await ht();await $t(),await Kt(r,o,n),await Bt(r,o,n),Q(!1),qt(n,o),ft(),i(o),e(n)}function Xt({setGraph:t,setCanvas:i,canvasRef:e}){S.useEffect(()=>{e.current&&Jt(e.current,t,i)},[])}function Qt(){const t=S.useRef(null),[i,e]=S.useState(void 0),[o,n]=S.useState(void 0);return Xt({setGraph:e,setCanvas:n,canvasRef:t}),g.jsxs(g.Fragment,{children:[g.jsx(zt,{graph:i,canvas:o}),g.jsx("canvas",{style:{position:"absolute",zIndex:0,touchAction:"none"},ref:t,id:"graph-canvas"})]})}J(document.getElementById("root")).render(g.jsxs(g.Fragment,{children:[g.jsx(Qt,{}),g.jsx(at,{style:{marginTop:"1.25em"},position:"top-right",autoClose:5e3,pauseOnHover:!1,draggable:!1,hideProgressBar:!0,theme:"colored"})]}));
