var ee=Object.defineProperty;var te=(e,i,t)=>i in e?ee(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t;var E=(e,i,t)=>te(e,typeof i!="symbol"?i+"":i,t);import{j as p,M as P,B as q,T as W,a as U,b as oe,d as ie,S as se}from"./@mui/material-BQdAtyIz.js";import{c as ne,r as S}from"./vendor-DM_OWPAt.js";import{B as T,Q as re}from"./react-toastify-6PrFfkGr.js";import{a as H}from"./axios-DXsv3KKR.js";import{F as ae}from"./file-saver-B2VyKP5u.js";import{H as le}from"./react-helmet-D1WOPrvJ.js";import{v as ue}from"./uuid-Ch9TGLTe.js";import{l as f}from"./litegraph.js-CpwqBUsj.js";import{z as u}from"./zod-DXqQCM1T.js";import"./@emotion/react-6hH5lGvJ.js";import"./@emotion/styled-BTak2TOH.js";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const n of l.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(s){if(s.ep)return;s.ep=!0;const l=t(s);fetch(s.href,l)}})();var Z,B=ne;Z=B.createRoot,B.hydrateRoot;async function ce(e){const i=e.serialize(),t={};for(const o of e.computeExecutionOrder(!1,0)){const s=i.nodes.find(d=>d.id===o.id);if(o.isVirtualNode){o.applyToGraph&&o.applyToGraph(i);continue}if(o.mode===2||o.mode===4)continue;const l={},n=o.widgets;if(n)for(const d in n){const r=n[d];(!r.options||r.options.serialize!==!1)&&(l[r.name]=r.serializeValue?await r.serializeValue(s,d):r.value)}for(let d in o.inputs){let r=o.getInputNode(d);if(r){let a=o.getInputLink(d);for(;r.mode===4||r.isVirtualNode;){let c=!1;if(r.isVirtualNode)a=r.getInputLink(a.origin_slot),a&&(r=r.getInputNode(a.target_slot),r&&(c=!0));else if(a&&r.mode===4){let h=[a.origin_slot];if(r.inputs){h=h.concat(Object.keys(r.inputs));for(let _ in h)if(_=h[_],r.inputs[_].type===o.inputs[d].type){a=r.getInputLink(_),a&&(r=r.getInputNode(_)),c=!0;break}}}if(!c)break}a&&(l[o.inputs[d].name]=[String(a.origin_id),parseInt(a.origin_slot)])}}t[String(o.id)]={inputs:l,class_type:o.comfyClass}}for(const o in t)for(const s in t[o].inputs)Array.isArray(t[o].inputs[s])&&t[o].inputs[s].length===2&&!t[t[o].inputs[s][0]]&&delete t[o].inputs[s];return{workflow:i,output:t}}const K=ue().toString().replace(/-/gi,"");class de{constructor(){E(this,"currentExecutingNode",null);E(this,"lastErrorNode",null);E(this,"errorNode",null)}}const L=new de;function pe(){const e=f.LGraphCanvas.prototype.drawNode,i=f.LGraphCanvas.prototype.drawNodeShape;f.LGraphCanvas.prototype.drawNodeShape=function(t,o,s,l,n,d,r){var m;const a=i.apply(this,arguments),c=(m=L.errorNode)==null?void 0:m[t.id.toString()];let h=null,_=1;if(t.id===+L.currentExecutingNode?h="#0f0":c!=null&&c.errors?(h="red",_=2):L.lastErrorNode&&+L.lastErrorNode.node_id===t.id&&(h="#f0f",_=2),h){const g=t._shape||t.shape||f.LiteGraph.ROUND_SHAPE;o.lineWidth=_,o.globalAlpha=.8,o.beginPath(),g==f.LiteGraph.BOX_SHAPE?o.rect(-6,-6-f.LiteGraph.NODE_TITLE_HEIGHT,12+s[0]+1,12+s[1]+f.LiteGraph.NODE_TITLE_HEIGHT):g==f.LiteGraph.ROUND_SHAPE||g==f.LiteGraph.CARD_SHAPE&&t.flags.collapsed?o.roundRect(-6,-6-f.LiteGraph.NODE_TITLE_HEIGHT,12+s[0]+1,12+s[1]+f.LiteGraph.NODE_TITLE_HEIGHT,this.round_radius*2):g==f.LiteGraph.CARD_SHAPE?o.roundRect(-6,-6-f.LiteGraph.NODE_TITLE_HEIGHT,12+s[0]+1,12+s[1]+f.LiteGraph.NODE_TITLE_HEIGHT,[this.round_radius*2,this.round_radius*2,2,2]):g==f.LiteGraph.CIRCLE_SHAPE&&o.arc(s[0]*.5,s[1]*.5,s[0]*.5+6,0,Math.PI*2),o.strokeStyle=h,o.stroke(),o.strokeStyle=l,o.globalAlpha=1}if(c){o.lineWidth=2,o.strokeStyle="red";for(const g of c.errors)if(g.extra_info&&g.extra_info.input_name){const w=t.findInputSlot(g.extra_info.input_name);if(w!==-1){let x=t.getConnectionPos(!0,w);o.beginPath(),o.arc(x[0]-t.pos[0],x[1]-t.pos[1],12,0,2*Math.PI,!1),o.stroke()}}}return a},f.LGraphCanvas.prototype.drawNode=function(t,o){var s=this.editor_alpha,l=t.bgcolor;t.mode===2&&(this.editor_alpha=.4),t.mode===4&&(t.bgcolor="#FF00FF",this.editor_alpha=.2);const n=e.apply(this,arguments);return this.editor_alpha=s,t.bgcolor=l,n}}let O=null;async function fe(){const e=await H.get("/api/object_info");if(e.status===200)return e.data}async function he(e){L.errorNode=null;const i=await ce(e),t=await H.post("/api/workflow",{workflow:i.output,client_id:K});if(t.status===200)return await t.data;throw{response:await t.data}}function J(e){if(!O)return O=new WebSocket(`/ws?clientId=${K}`),O.binaryType="arraybuffer",O.addEventListener("open",()=>{e?(console.log("WebSocket Reconnected"),dispatchEvent(new CustomEvent("reconnected"))):console.log("WebSocket Open")}),O.addEventListener("error",()=>{O&&O.close(),console.log("WebSocket Error")}),O.addEventListener("close",()=>{console.log("Reconnecting"),dispatchEvent(new CustomEvent("reconnecting")),setTimeout(()=>{O=null,O=J(!0)},300)}),O.addEventListener("message",i=>{try{const t=JSON.parse(i.data);switch(t.type){case"status":dispatchEvent(new CustomEvent("status",{detail:t.data.status}));break;case"progress":dispatchEvent(new CustomEvent("progress",{detail:t.data}));break;case"executing":dispatchEvent(new CustomEvent("executing",{detail:t.data.node}));break;case"progress":case"executed":case"execution_start":case"execution_success":case"execution_error":case"execution_cached":case"logs":dispatchEvent(new CustomEvent(t.type,{detail:t.data}));break}}catch(t){console.warn("Unhandled message:",i.data,t)}}),O}const M=u.union([u.number().int(),u.string()]),$=u.union([u.object({0:u.number(),1:u.number()}).passthrough().transform(e=>[e[0],e[1]]),u.tuple([u.number(),u.number()])]),ge=u.object({collapsed:u.boolean().optional(),pinned:u.boolean().optional(),allow_interaction:u.boolean().optional(),horizontal:u.boolean().optional(),skip_repeated_outputs:u.boolean().optional()}).passthrough(),A=u.union([u.string(),u.array(u.string()),u.number()]),D=u.union([u.number().int(),u.string().transform(e=>parseInt(e)).refine(e=>!isNaN(e),{message:"Invalid number"})]),me=u.object({name:u.string(),type:A,link:u.number().nullable().optional(),slot_index:D.optional()}).passthrough(),ye=u.object({name:u.string(),type:A,links:u.array(u.number()).nullable().optional(),slot_index:D.optional()}).passthrough(),_e=u.object({"Node name for S&R":u.string().optional()}).passthrough(),we=u.union([u.array(u.any()),u.record(u.any())]),be=u.object({id:M,type:u.string(),pos:$,size:$,flags:ge,order:u.number(),mode:u.number(),inputs:u.array(me).optional(),outputs:u.array(ye).optional(),title:u.string().optional(),properties:_e,widgets_values:we.optional(),color:u.string().optional(),bgcolor:u.string().optional()}).passthrough(),xe=u.tuple([u.number(),M,D,M,D,A]),Ee=u.object({title:u.string(),bounding:u.tuple([u.number(),u.number(),u.number(),u.number()]),color:u.string().optional(),font_size:u.number().optional(),locked:u.boolean().optional()}).passthrough(),ve=u.object({links_ontop:u.boolean().optional(),align_to_grid:u.boolean().optional()}).passthrough(),Ne=u.object({last_node_id:u.number(),last_link_id:u.number(),nodes:u.array(be),links:u.array(xe),groups:u.array(Ee).optional(),config:ve.optional().nullable(),version:u.number()});function Le(e){try{const i=JSON.parse(e);return Ne.parse(i)}catch(i){throw i instanceof u.ZodError?console.error("Validation error:",i.errors):console.error("Parsing error:",i),Error(i)}}const ke=(e,i,t,o)=>{var l;const s=(l=o.target.files)==null?void 0:l[0];if(s&&i){L.currentExecutingNode=null,L.errorNode=null,L.lastErrorNode=null;const n=new FileReader;return n.onload=d=>{var r;try{const a=(r=d.target)==null?void 0:r.result,c=Le(a);i.clear(),i.configure(c),e&&(e.value=""),t.ds.offset=[0,0],t.setZoom(1,[0,0]),t.setDirty(!0,!0),T.success("Loading Workflow Success")}catch{T.error("Error loading workflow file. Please ensure it is a valid workflow.")}},n.onerror=()=>{T.error("Error reading file")},n.readAsText(s),s.name}},Se={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"800px",height:"auto",bgcolor:"background.paper",border:"2px solid #000",boxShadow:24,p:4};function Ie(){const[e,i]=S.useState(!1),t=()=>i(!0),o=()=>i(!1),[s,l]=S.useState({traceback:[],node_id:"",node_type:"",exception_type:"",exception_message:""});return window.addEventListener("execution_error",({detail:n})=>{l(n),t()}),p.jsx("div",{children:p.jsx(P,{open:e,onClose:o,"aria-labelledby":"modal-modal-title","aria-describedby":"modal-modal-description",children:p.jsxs(q,{sx:Se,children:[p.jsxs(W,{id:"modal-modal-title",variant:"h5",component:"h2",children:[p.jsx("i",{className:"pi pi-exclamation-triangle",style:{color:"#ff4545"}})," ","Error Workflow Execution"]}),p.jsxs(W,{id:"modal-modal-title",fontFamily:"monospace",children:[s.exception_type," ",p.jsx("br",{})," ",s.exception_message," "]}),p.jsx(W,{id:"modal-modal-description",sx:{mt:2},fontFamily:"monospace",variant:"caption",color:"#828282",children:s.traceback}),p.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:p.jsx(U,{onClick:o,children:"Close"})})]})})})}const Oe={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"400px",bgcolor:"background.paper",border:"2px solid #000",boxShadow:24,p:4};function Ce({handleOpen:e,handleClose:i,open:t,invaliddetail:o}){return p.jsx("div",{children:p.jsx(P,{open:t,onClose:i,"aria-labelledby":"modal-modal-title","aria-describedby":"modal-modal-description",children:p.jsxs(q,{sx:Oe,children:[p.jsxs(W,{id:"modal-modal-title",variant:"h5",component:"h2",children:[p.jsx("i",{className:"pi pi-exclamation-circle",style:{color:"#ffc400"}})," ","Invalid Workflow"]}),p.jsxs(W,{id:"modal-modal-description",sx:{mt:2},fontFamily:"monospace",variant:"caption",children:[p.jsx("p",{style:{fontSize:"120%"},children:o.error.message}),Object.keys(o.node_errors).map(s=>p.jsxs("p",{style:{fontSize:"110%"},children:[p.jsxs("span",{style:{fontWeight:"bold"},children:["#",s," ",o.node_errors[s].class_type," :"]}),p.jsx("br",{}),o.node_errors[s].errors.map(l=>p.jsxs("span",{children:[`${l.details} - ${l.message}`,p.jsx("br",{})]},Date.now()+Math.random()))]},Date.now()+Math.random()))]}),p.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:p.jsx(U,{onClick:i,children:"Close"})})]})})})}function Te(){const[e,i]=S.useState(!1);S.useEffect(()=>{e?T.error("Reconnecting",{autoClose:!1}):(T.dismiss(),T.success("Connected to Websocket"))},[e]),window.addEventListener("reconnecting",()=>{e||i(!0)}),window.addEventListener("reconnected",()=>{e&&i(!1)})}function je({graph:e,canvas:i}){const t=S.useRef(null),[o,s]=S.useState(!1),[l,n]=S.useState(!0),[d,r]=S.useState(null),[a,c]=S.useState("untitled"),[h,_]=S.useState({error:{},node_errors:{}});Te();const[m,g]=S.useState(!1),w=()=>{var b;(b=t.current)==null||b.click()},x=()=>{if(e){const b=JSON.stringify(e.serialize()),C=new Blob([b],{type:"text/plain;charset=utf-8"}),I=prompt("Enter Filename : ",`workflow-${Date.now()}`);if(I===null)return;ae.saveAs(C,`${I}.json`),r(e.serialize()),c(I)}},j=()=>g(!0),z=()=>g(!1),v=()=>{e&&confirm("Clear workflow?")&&(L.currentExecutingNode=null,L.errorNode=null,L.lastErrorNode=null,e.clear(),T.info("Workflow Cleared"),c("untitled"),i.ds.offset=[0,0],i.setZoom(1,[0,0]),i.setDirty(!0,!0))},k=async()=>{try{L.currentExecutingNode=null,L.errorNode=null,L.lastErrorNode=null;const b=await he(e);e.start(),s(!0)}catch(b){L.errorNode=b.response.data.node_errors,_(b.response.data),g(!0),s(!1)}},y=async()=>{try{await H.post("/api/interrupt",null),await T.warning("Workflow Interrupt")}catch(b){console.error(b)}finally{s(!1)}};window.addEventListener("execution_success",({detail:b})=>{s(!1)}),window.addEventListener("execution_error",({detail:b})=>{s(!1)});const N=oe({palette:{mode:"dark"}});return p.jsxs(p.Fragment,{children:[p.jsx(le,{children:p.jsxs("title",{children:[l?"":"*",a+" ","- AdvCal FBP"]})}),p.jsx(ie,{theme:N,children:p.jsxs(se,{enableColorScheme:!0,children:[p.jsx(Ie,{}),p.jsx(Ce,{handleOpen:j,handleClose:z,open:m,invaliddetail:h})]})}),p.jsxs("div",{className:"topbar",children:[p.jsxs("div",{className:"leftmenu",children:[p.jsxs("button",{className:"buttonmenu",onClick:x,children:[p.jsx("i",{className:"pi pi-save"})," Save"]}),p.jsxs("button",{className:"buttonmenu",onClick:w,children:[p.jsx("i",{className:"pi pi-upload"})," Load"]}),p.jsx("input",{type:"file",ref:t,onChange:b=>{const C=ke(t.current,e,i,b);C&&c(C.split(".")[0])},accept:".json",style:{display:"none"}}),p.jsxs("button",{className:"buttonmenu",onClick:v,children:[p.jsx("i",{className:"pi pi-eraser"})," Clear"]})]}),p.jsx("div",{className:"rightmenu",children:p.jsx("button",{className:"buttonmenuright",onClick:async()=>{o?await y():await k()},children:o?p.jsxs("span",{children:[p.jsx("i",{className:"pi pi-stop"})," Interrupt Workflow"]}):p.jsxs("span",{children:[p.jsx("i",{className:"pi pi-play"})," Run Workflow"]})})})]})]})}const R=Symbol(),V=Symbol();function Ge(e,i,t,o,s){function n(r){var m,g;if(e.widgets[0].last_y==null)return;let a=e.widgets[0].last_y,c=r[1]-a,h=0;const _=[];for(let w=0;w<e.widgets.length;w++){const x=e.widgets[w];x.type==="customtext"?_.push(x):x.computeSize?h+=x.computeSize(null)[1]+4:h+=f.LiteGraph.NODE_WIDGET_HEIGHT+4}c-=h,c/=_.length+(((m=e.imgs)==null?void 0:m.length)||0),c<50&&(c=50,e.size[1]=a+h+c*(_.length+(((g=e.imgs)==null?void 0:g.length)||0)),e.graph.setDirtyCanvas(!0));for(const w of e.widgets)w.y=a,w.type==="customtext"?(a+=c,w.computedHeight=c-_.length*4):w.computeSize?a+=w.computeSize()[1]+4:a+=f.LiteGraph.NODE_WIDGET_HEIGHT+4;e.inputHeight=c}const d={type:"customtext",name:i,get value(){return this.inputEl.value},set value(r){this.inputEl.value=r},draw:function(r,a,c,h,_){this.parent.inputHeight||n(e.size);const m=s.ds.scale>.5&&this.type==="customtext",g=10,w=r.canvas.getBoundingClientRect(),x=new DOMMatrix().scaleSelf(w.width/r.canvas.width,w.height/r.canvas.height).multiplySelf(r.getTransform()).translateSelf(g,g+h),j=new DOMMatrix().scaleSelf(x.a,x.d);Object.assign(this.inputEl.style,{transformOrigin:"0 0",transform:j,left:`${x.a+x.e}px`,top:`${x.d+x.f}px`,width:`${c-g*2}px`,height:`${this.parent.inputHeight-g*2}px`,position:"absolute",background:e.color?e.color:"",color:e.color?"white":"",zIndex:o._nodes.indexOf(e)}),this.inputEl.hidden=!m}};if(d.inputEl=document.createElement("textarea"),d.inputEl.className="comfy-multiline-input",d.inputEl.value=t.defaultVal,d.inputEl.placeholder=t.placeholder||"",document.addEventListener("mousedown",function(r){d.inputEl.contains(r.target)||d.inputEl.blur()}),d.parent=e,document.body.appendChild(d.inputEl),e.addCustomWidget(d),s.onDrawBackground=function(){for(let r in o._nodes){const a=o._nodes[r];for(let c in a.widgets){let h=a.widgets[c];Object.hasOwn(h,"inputEl")&&(h.inputEl.style.left="-8000px",h.inputEl.style.position="absolute")}}},e.onRemoved=function(){for(let r in this.widgets)this.widgets[r].inputEl&&this.widgets[r].inputEl.remove()},d.onRemove=()=>{var r;(r=d.inputEl)==null||r.remove(),--e[R]||(e.onResize=e[V],delete e[R],delete e[V])},e[R])e[R]++;else{e[R]=1;const r=e[V]=e.onResize;e.onResize=function(a){n(a),r&&r.apply(this,arguments)}}return{minWidth:400,minHeight:200,widget:d}}function X(e,i){let t=e[1].defaultVal,{min:o,max:s,step:l}=e[1];return t==null&&(t=0),o==null&&(o=-2147483648),s==null&&(s=2147483647),l==null?l=i:l*=10,e[1].min=o,e[1].max=s,e[1].step=l,{val:t,config:{...e[1],precision:4}}}function Q(e){return e==="slider"?"slider":"number"}function ze(e,i,t){let o=Q(t[1].display);const{val:s,config:l}=X(t,10);return Object.assign(l,{precision:0}),{widget:e.addWidget(o,i,s,function(n){const d=this.options.step/10;let r=this.options.min%d;isNaN(r)&&(r=0),this.value=Math.round((n-r)/d)*d+r},l)}}const G={FLOAT(e,i,t){let o=Q(t[1].display),{val:s,config:l}=X(t,.5);return{widget:e.addWidget(o,i,s,()=>{},l)}},INT(e,i,t){return ze(e,i,t)},BOOLEAN(e,i,t){let o=t[1].defaultVal;return{widget:e.addWidget("toggle",i,o,()=>{},{on:t[1].label_on,off:t[1].label_off})}},STRING(e,i,t,o,s){const l=t[1].defaultVal?t[1].defaultVal:"",n=!!t[1].multiline;let d;return n?d=Ge(e,i,t[1],o,s):d={widget:e.addWidget("text",i,l,()=>{},{})},t[1].dynamicPrompts!=null&&(d.widget.dynamicPrompts=t[1].dynamicPrompts),d},COMBO(e,i,t){const o=t[0];let s=o[0];return t[1]&&t[1].defaultVal&&(s=t[1].defaultVal),{widget:e.addWidget("combo",i,s,()=>{},{values:o})}},SELECTFILE(e,i,t,o,s){let l;const n=document.createElement("input");return Object.assign(n,{type:"file",style:"display: none",onchange:async()=>{if(n.files.length){const d=n.files[0],r=new FormData;r.append("file",d);const a=await H.post("/api/upload/file",r);if(a.status!==200){console.error(a.data);return}e.widgets[0].value=a.data.path,n.value=""}}}),document.body.append(n),l=e.addWidget("button","Select File","file",()=>{n.click()}),e.onRemoved=function(){n.remove()},l.serialize=!1,{widget:l}}};async function Re(e,i){class t{constructor(){E(this,"properties");E(this,"serialize_widgets");E(this,"isVirtualNode");E(this,"color",f.LGraphCanvas.node_colors.yellow.color);E(this,"bgcolor",f.LGraphCanvas.node_colors.yellow.bgcolor);E(this,"groupcolor",f.LGraphCanvas.node_colors.yellow.groupcolor);this.properties||(this.properties={},this.properties.text=""),G.STRING(this,"",["",{defaultVal:this.properties.text,multiline:!0}],e,i),this.serialize_widgets=!0,this.isVirtualNode=!0}}E(t,"category"),f.LiteGraph.registerNodeType("Note",Object.assign(t,{title_mode:f.LiteGraph.NORMAL_TITLE,title:"Note",collapsable:!0})),t.category="utils"}async function We(e,i){const o=class o{constructor(){E(this,"size");E(this,"__outputType");E(this,"inputs");E(this,"outputs");E(this,"isVirtualNode");E(this,"horizontal");E(this,"properties");this.properties||(this.properties={}),this.properties.showOutputText=o.defaultVisibility,this.properties.horizontal=!1;const l=this;l.addInput("","*"),l.addOutput(this.properties.showOutputText?"*":"","*"),l.onConnectionsChange=function(n,d,r,a){var z;if(this.applyOrientation(),r&&n===f.LiteGraph.OUTPUT&&new Set(this.outputs[0].links.map(k=>e.links[k].type).filter(k=>k!=="*")).size>1){const k=[];for(let y=0;y<this.outputs[0].links.length-1;y++){const N=this.outputs[0].links[y],b=e.links[N];k.push(b)}for(const y of k)e.getNodeById(y.target_id).disconnectInput(y.target_slot)}let c=this,h=[],_=null,m=null;for(;c;){h.unshift(c);const v=c.inputs[0].link;if(v!==null){const k=e.links[v],y=e.getNodeById(k.origin_id);if(y.constructor.type==="Reroute")y===this?(c.disconnectInput(k.target_slot),c=null):c=y;else{m=c,_=((z=y.outputs[k.origin_slot])==null?void 0:z.type)??null;break}}else{c=null;break}}const g=[this];let w=null;for(;g.length;){c=g.pop();const v=(c.outputs?c.outputs[0].links:[])||[];if(v.length)for(const k of v){const y=e.links[k];if(!y)continue;const N=e.getNodeById(y.target_id);if(N.constructor.type==="Reroute")g.push(N),h.push(N);else{const C=N.inputs&&N.inputs[y==null?void 0:y.target_slot]&&N.inputs[y.target_slot].type?N.inputs[y.target_slot].type:null;_&&C!==_?N.disconnectInput(y.target_slot):w=C}}}const x=_||w||"*",j=f.LGraphCanvas.link_type_colors[x];for(const v of h){v.outputs[0].type=_||"*",v.__outputType=x,v.outputs[0].name=v.properties.showOutputText?x:"",v.size=v.computeSize(),v.applyOrientation();for(const k of v.outputs[0].links||[]){const y=e.links[k];y&&(y.color=j)}}if(m){const v=e.links[m.inputs[0].link];v&&(v.color=j)}},this.clone=function(){const n=o.prototype.clone.apply(this);return n.removeOutput(0),n.addOutput(this.properties.showOutputText?"*":"","*"),n.size=n.computeSize(),n},this.isVirtualNode=!0}getExtraMenuOptions(l,n){n.unshift({content:(this.properties.showOutputText?"Hide":"Show")+" Type",callback:()=>{this.properties.showOutputText=!this.properties.showOutputText,this.properties.showOutputText?this.outputs[0].name=this.__outputType||this.outputs[0].type:this.outputs[0].name="",this.size=this.computeSize(),this.applyOrientation(),e.setDirtyCanvas(!0,!0)}},{content:(o.defaultVisibility?"Hide":"Show")+" Type By Default",callback:()=>{o.setDefaultTextVisibility(!o.defaultVisibility)}},{content:"Set "+(this.properties.horizontal?"Horizontal":"Vertical"),callback:()=>{this.properties.horizontal=!this.properties.horizontal,this.applyOrientation()}})}applyOrientation(){this.horizontal=this.properties.horizontal,this.horizontal?this.inputs[0].pos=[this.size[0]/2,0]:delete this.inputs[0].pos,e.setDirtyCanvas(!0,!0)}computeSize(){return[this.properties.showOutputText&&this.outputs&&this.outputs.length?Math.max(75,f.LiteGraph.NODE_TEXT_SIZE*this.outputs[0].name.length*.6+40):75,26]}clone(){}static setDefaultTextVisibility(l){o.defaultVisibility=l,l?localStorage["Comfy.RerouteNode.DefaultVisibility"]="true":delete localStorage["Comfy.RerouteNode.DefaultVisibility"]}};E(o,"category"),E(o,"defaultVisibility");let t=o;t.setDefaultTextVisibility(!!localStorage["Comfy.RerouteNode.DefaultVisibility"]),f.LiteGraph.registerNodeType("Reroute",Object.assign(t,{title_mode:f.LiteGraph.NO_TITLE,title:"Reroute",collapsable:!1})),t.category="utils"}async function He(e,i,t){const o=a=>Object.keys(a).sort().reduce((c,h)=>(c[h]=a[h],c),{});function s(){var a=[];const c=e;for(const _ in c){const m=c[_];var h=m.input.required;m.input.optional!==void 0&&(h=Object.assign({},m.input.required,m.input.optional));for(const g in h){const x=h[g][0];Array.isArray(x)||a.push(x)}for(const g in m.output){const w=m.output[g];a.push(w)}}return a}function l(a){var c=s();for(const h of c)a.colors.node_slot[h]||(a.colors.node_slot[h]="");return a.colors.node_slot=o(a.colors.node_slot),a}const n=async a=>{if(a=await l(a),a.colors){if(a.colors.node_slot&&(Object.assign(t.default_connection_color_byType,a.colors.node_slot),Object.assign(f.LGraphCanvas.link_type_colors,a.colors.node_slot)),a.colors.litegraph_base){t.node_title_color=a.colors.litegraph_base.NODE_TITLE_COLOR,t.default_link_color=a.colors.litegraph_base.LINK_COLOR;for(const c in a.colors.litegraph_base)a.colors.litegraph_base.hasOwnProperty(c)&&f.LiteGraph.hasOwnProperty(c)&&(f.LiteGraph[c]=a.colors.litegraph_base[c])}t.draw(!0,!0)}};let r=await(await H.get("/api/color_palette")).data.dark;await n(r)}function De(){f.LiteGraph.search_filter_enabled=!1,f.LiteGraph.middle_click_slot_add_default_node=!0}async function Ve(e,i,t){var a;var o=i.name;const s=(a=i.input)==null?void 0:a.required;for(const c in s){var l=s[c];if(typeof l[0]!="string")continue;var n=l[0];if(n in G){var d=l[1];if(!(d!=null&&d.forceInput))continue}if(n in t.slot_types_default_out||(t.slot_types_default_out[n]=["Reroute"]),t.slot_types_default_out[n].includes(o))continue;t.slot_types_default_out[n].push(o);const h=n.toLocaleLowerCase();h in f.LiteGraph.registered_slot_in_types||(f.LiteGraph.registered_slot_in_types[h]={nodes:[]}),f.LiteGraph.registered_slot_in_types[h].nodes.push(e.comfyClass)}var r=i.output;for(const c in r){var n=r[c];n in t.slot_types_default_in||(t.slot_types_default_in[n]=["Reroute"]),t.slot_types_default_in[n].push(o),n in f.LiteGraph.registered_slot_out_types||(f.LiteGraph.registered_slot_out_types[n]={nodes:[]}),f.LiteGraph.registered_slot_out_types[n].nodes.push(e.comfyClass),f.LiteGraph.slot_types_out.includes(n)||f.LiteGraph.slot_types_out.push(n)}f.LiteGraph.slot_types_default_out={},f.LiteGraph.slot_types_default_in={};for(const c in t.slot_types_default_out)f.LiteGraph.slot_types_default_out[c]=t.slot_types_default_out[c].slice(0,5);for(const c in t.slot_types_default_in)f.LiteGraph.slot_types_default_in[c]=t.slot_types_default_in[c].slice(0,5)}async function Me(e,i,t){await Re(i,t),await We(i),await He(e,i,t)}async function Ae(e,i,t){await De()}function Fe(e){if(e==null)return"(unknown error)";const i=e.traceback.join("");return e.node_id,`Error occurred when executing ${e.node_type}:

${e.exception_message}

${i}`}function Be(e,i){window.addEventListener("status",({detail:t})=>{console.log("status",t)}),window.addEventListener("reconnecting",()=>{console.log("Reconnecting...")}),window.addEventListener("progress",({detail:t})=>{i.setDirtyCanvas(!0,!1)}),window.addEventListener("executing",({detail:t})=>{L.currentExecutingNode=t,i.setDirtyCanvas(!0,!1)}),window.addEventListener("executed",({detail:t})=>{L.currentExecutingNode=null;const o=i.getNodeById(t.node);o&&o.onExecuted&&o.onExecuted(t.output)}),window.addEventListener("execution_start",({detail:t})=>{L.lastErrorNode=null,T.info("Workflow Start")}),window.addEventListener("execution_success",({detail:t})=>{T.info("Workflow Execution Success"),i.stop()}),window.addEventListener("execution_error",({detail:t})=>{const o=Fe(t);L.lastErrorNode=t,L.currentExecutingNode=null,i.stop(),console.error(o)})}async function $e(e){var i,t,o,s;((s=(o=(t=(i=e==null?void 0:e.input)==null?void 0:i.required)==null?void 0:t.path)==null?void 0:o[1])==null?void 0:s.select_file_path)===!0&&(e.input.required.selectfile=["SELECTFILE"])}async function Pe(e,i,t,o){if(i.name==="ShowText"){let s=function(l){var n,d;if(this.widgets){const r=this.widgets.findIndex(a=>a.name==="text");if(r!==-1){for(let a=r;a<this.widgets.length;a++)(d=(n=this.widgets[a]).onRemove)==null||d.call(n);this.widgets.length=r}}for(const r of l){const a=G.STRING(this,"text",["STRING",{multiline:!0}],t,o).widget;a.inputEl.readOnly=!0,a.inputEl.style.opacity=1,a.value=r}requestAnimationFrame(()=>{var a;const r=this.computeSize();r[0]<this.size[0]&&(r[0]=this.size[0]),r[1]<this.size[1]&&(r[1]=this.size[1]),(a=this.onResize)==null||a.call(this,r),t.setDirtyCanvas(!0,!1)})};e.onExecuted,e.prototype.onExecuted=function(l){s.call(this,l.text)}}}async function qe(e,i,t,o){i.name==="PreviewImage"&&(e.prototype.onExecuted=function(s){this.img=document.createElement("img"),this.img.src=s.images[0],t.setDirtyCanvas(!0,!1)},e.prototype.onDrawBackground=function(s){!this.flags.collapsed&&this.img&&this.img.width>0&&this.size[0]>5&&this.size[1]>5&&s.drawImage(this.img,2*5,2*12,this.size[0]-2*10,this.size[1]-2*12)})}async function Ue(e,i,t){var s;const o={slot_types_default_out:{},slot_types_default_in:{}};for(const l in e){const n=e[l];await $e(n);const d=(s=class extends f.LGraphNode{constructor(c){var w,x,j,z,v,k;super(c);E(this,"comfyClass",n.name);E(this,"graph",i);E(this,"canvas",t);const h=n.input.required;var _=n.input.required;n.input.optional!=null&&(_=Object.assign({},n.input.required,n.input.optional));const m={minWidth:1,minHeight:1};for(const y in _){const N=_[y],b=N[0],C=N[1]??{},I=[b,C],Y=h&&y in h;let F=!0;(w=I[1])!=null&&w.forceInput?this.addInput(y,b):Array.isArray(b)?Object.assign(m,G.COMBO(this,y,I)||{}):`${b}:${y}`in G?Object.assign(m,G[`${b}:${y}`](this,y,I,this.graph,this.canvas)||{}):b in G?Object.assign(m,G[b](this,y,I,this.graph,this.canvas)||{}):(this.addInput(y,b),F=!1),F&&(m!=null&&m.widget)&&((x=m.widget).options??(x.options={}),Y||(m.widget.options.inputIsOptional=!0),(j=I[1])!=null&&j.forceInput&&(m.widget.options.forceInput=!0),(z=I[1])!=null&&z.defaultInput&&(m.widget.options.defaultInput=!0),(v=I[1])!=null&&v.advanced&&(m.widget.advanced=!0),(k=I[1])!=null&&k.hidden&&(m.widget.hidden=!0))}for(const y in n.output){let N=n.output[y];N instanceof Array&&(N="COMBO");const b=n.output_name[y]||N,I={shape:n.output_is_list[y]?f.LiteGraph.GRID_SHAPE:f.LiteGraph.CIRCLE_SHAPE};this.addOutput(b,N,I)}const g=this.computeSize();g[0]=Math.max(m.minWidth,g[0]*1.5),g[1]=Math.max(m.minHeight,g[1]),n.name==="PreviewImage"&&(g[0]=320,g[1]=240),this.size=g,this.serialize_widgets=!0}configure(c){const h=(_,m)=>{const g={...m};if(_.widget===void 0&&m.widget!==void 0)return this.inputs.push(_),m;for(const w of["name","type","shape"])_[w]!==void 0&&(g[w]=_[w]);return g};for(const _ of["inputs","outputs"]){const m=c[_]??[];c[_]=m.map((g,w)=>h(this[_][w]??{},g))}super.configure(c)}},E(s,"title",n.display_name?n.display_name:n.name),E(s,"nodeData",n),E(s,"category"),s);await Pe(d,n,i,t),await qe(d,n,i),await Ve(d,n,o),f.LiteGraph.registerNodeType(l,d),d.category=n.category}}async function Ze(e,i,t){const o=new f.LGraph,s=new f.LGraphCanvas(e,o);function l(){const d=Math.max(window.devicePixelRatio,1),{width:r,height:a}=e.getBoundingClientRect();e.width=Math.round(r*d),e.height=Math.round(a*d),e.getContext("2d").scale(d,d),s.draw(!0,!0)}l(),window.addEventListener("resize",l),f.LiteGraph.release_link_on_empty_shows_menu=!0,f.LiteGraph.alt_drag_do_clone_nodes=!0,f.LiteGraph.clearRegisteredTypes();const n=await fe();await Ae(),await Ue(n,o,s),await Me(n,o,s),J(!1),Be(s,o),pe(),i(o),t(s)}function Ke({setGraph:e,setCanvas:i,canvasRef:t}){S.useEffect(()=>{t.current&&Ze(t.current,e,i)},[])}function Je(){const e=S.useRef(null),[i,t]=S.useState(void 0),[o,s]=S.useState(void 0);return Ke({setGraph:t,setCanvas:s,canvasRef:e}),p.jsxs(p.Fragment,{children:[p.jsx(je,{graph:i,canvas:o}),p.jsx("canvas",{style:{position:"absolute",zIndex:0,touchAction:"none"},ref:e,id:"graph-canvas"})]})}Z(document.getElementById("root")).render(p.jsxs(p.Fragment,{children:[p.jsx(Je,{}),p.jsx(re,{style:{marginTop:"1.25em"},position:"top-right",autoClose:5e3,pauseOnHover:!1,draggable:!1,hideProgressBar:!0,theme:"colored"})]}));
